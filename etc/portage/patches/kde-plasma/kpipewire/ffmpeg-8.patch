From 021d6ff710e2b6231df78c1c2ae9950ba336e86d Mon Sep 17 00:00:00 2001
From: Eden Rose <ero53@deep-rose.org>
Date: Fri, 2 May 2025 09:55:41 +1000
Subject: [PATCH] FFmpeg API Depreciation: FF_PROFILE_*; AV_PROFILE_*

---
 src/h264vaapiencoder.cpp   | 18 +++++++++++++++---
 src/libopenh264encoder.cpp | 18 +++++++++++++++---
 src/libx264encoder.cpp     | 18 +++++++++++++++---
 3 files changed, 45 insertions(+), 9 deletions(-)

diff --git a/src/h264vaapiencoder.cpp b/src/h264vaapiencoder.cpp
index 0cf251b..17a413f 100644
--- a/src/h264vaapiencoder.cpp
+++ b/src/h264vaapiencoder.cpp
@@ -130,13 +130,25 @@ bool H264VAAPIEncoder::initialize(const QSize &size)
 
     switch (m_profile) {
     case H264Profile::Baseline:
-        m_avCodecContext->profile = FF_PROFILE_H264_CONSTRAINED_BASELINE;
+        #if LIBAVCODEC_VERSION_INT < AV_VERSION_INT(60, 31, 102)
+         m_avCodecContext->profile = FF_PROFILE_H264_CONSTRAINED_BASELINE;
+        #else
+         m_avCodecContext->profile = AV_PROFILE_H264_CONSTRAINED_BASELINE;
+        #endif
         break;
     case H264Profile::Main:
-        m_avCodecContext->profile = FF_PROFILE_H264_MAIN;
+        #if LIBAVCODEC_VERSION_INT < AV_VERSION_INT(60, 31, 102)
+         m_avCodecContext->profile = FF_PROFILE_H264_MAIN;
+        #else
+         m_avCodecContext->profile = AV_PROFILE_H264_MAIN;
+        #endif
         break;
     case H264Profile::High:
-        m_avCodecContext->profile = FF_PROFILE_H264_HIGH;
+        #if LIBAVCODEC_VERSION_INT < AV_VERSION_INT(60, 31, 102)
+         m_avCodecContext->profile = FF_PROFILE_H264_HIGH;
+        #else
+         m_avCodecContext->profile = AV_PROFILE_H264_HIGH;;
+        #endif
         break;
     }
 
diff --git a/src/libopenh264encoder.cpp b/src/libopenh264encoder.cpp
index db6ed4d..b1fb2bd 100644
--- a/src/libopenh264encoder.cpp
+++ b/src/libopenh264encoder.cpp
@@ -64,13 +64,25 @@ bool LibOpenH264Encoder::initialize(const QSize &size)
         // passes that through, but libopenh264 only allows BASELINE.
         // Until that bug is fixed there'll always be a warning that the
         // profile is not supported (https://github.com/cisco/openh264/issues/3613)
-        m_avCodecContext->profile = FF_PROFILE_H264_CONSTRAINED_BASELINE;
+        #if LIBAVCODEC_VERSION_INT < AV_VERSION_INT(60, 31, 102)
+         m_avCodecContext->profile = FF_PROFILE_H264_CONSTRAINED_BASELINE;
+        #else
+         m_avCodecContext->profile = AV_PROFILE_H264_CONSTRAINED_BASELINE;
+        #endif
         break;
     case H264Profile::Main:
-        m_avCodecContext->profile = FF_PROFILE_H264_MAIN;
+        #if LIBAVCODEC_VERSION_INT < AV_VERSION_INT(60, 31, 102)
+         m_avCodecContext->profile = FF_PROFILE_H264_MAIN;
+        #else
+         m_avCodecContext->profile = AV_PROFILE_H264_MAIN;
+        #endif
         break;
     case H264Profile::High:
-        m_avCodecContext->profile = FF_PROFILE_H264_HIGH;
+        #if LIBAVCODEC_VERSION_INT < AV_VERSION_INT(60, 31, 102)
+         m_avCodecContext->profile = FF_PROFILE_H264_HIGH;
+        #else
+         m_avCodecContext->profile = AV_PROFILE_H264_HIGH;
+        #endif  
         break;
     }
 
diff --git a/src/libx264encoder.cpp b/src/libx264encoder.cpp
index d9fe44f..768e2bb 100644
--- a/src/libx264encoder.cpp
+++ b/src/libx264encoder.cpp
@@ -68,13 +68,25 @@ bool LibX264Encoder::initialize(const QSize &size)
 
     switch (m_profile) {
     case H264Profile::Baseline:
-        m_avCodecContext->profile = FF_PROFILE_H264_BASELINE;
+        #if LIBAVCODEC_VERSION_INT < AV_VERSION_INT(60, 31, 102)
+         m_avCodecContext->profile = FF_PROFILE_H264_BASELINE;
+        #else
+         m_avCodecContext->profile = AV_PROFILE_H264_BASELINE;
+        #endif
         break;
     case H264Profile::Main:
-        m_avCodecContext->profile = FF_PROFILE_H264_MAIN;
+        #if LIBAVCODEC_VERSION_INT < AV_VERSION_INT(60, 31, 102)
+         m_avCodecContext->profile = FF_PROFILE_H264_MAIN;
+        #else
+         m_avCodecContext->profile = AV_PROFILE_H264_MAIN;
+        #endif
         break;
     case H264Profile::High:
-        m_avCodecContext->profile = FF_PROFILE_H264_HIGH;
+        #if LIBAVCODEC_VERSION_INT < AV_VERSION_INT(60, 31, 102)
+         m_avCodecContext->profile = FF_PROFILE_H264_HIGH;
+        #else
+         m_avCodecContext->profile = AV_PROFILE_H264_HIGH;
+        #endif
         break;
     }
 
-- 
GitLab

